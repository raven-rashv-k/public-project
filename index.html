<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neutonian AI Chat</title>
    <!-- Use Tailwind CSS for a modern, responsive look without external stylesheets -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a custom CSS animation for the dot-pulse loading indicator */
        .dot-pulse {
            position: relative;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #9ca3af;
            color: #9ca3af;
            animation: dot-pulse 1s infinite linear;
        }

        .dot-pulse::before,
        .dot-pulse::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #9ca3af;
            animation: dot-pulse 1s infinite linear;
        }

        .dot-pulse::before {
            animation-delay: 0.2s;
            left: -12px;
        }

        .dot-pulse::after {
            animation-delay: 0.4s;
            left: 12px;
        }

        @keyframes dot-pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 antialiased font-sans">
    <div id="app-container" class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-2xl flex flex-col h-[calc(100vh-2rem)] md:h-[80vh]">

        <!-- Main Title and Reset Button -->
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-extrabold text-gray-800">Neutonian AI Chat</h1>
            <button id="reset-button" class="hidden px-4 py-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors shadow-md text-sm">
                Reset
            </button>
        </div>

        <!-- Setup Section (Initial View) -->
        <div id="setup-section" class="flex flex-col space-y-4">
            <p class="text-sm text-gray-600">
                Enter your Gemini API key to start a conversation. You can get one from
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">AI Studio</a>.
            </p>
            <div class="flex flex-col space-y-2">
                <label for="api-key-input" class="text-sm font-medium text-gray-700">API Key</label>
                <input
                    id="api-key-input"
                    type="password"
                    placeholder="Enter your API key"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                >
            </div>
            <div class="flex flex-col space-y-2">
                <label for="model-select" class="text-sm font-medium text-gray-700">Select Model</label>
                <select
                    id="model-select"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                >
                    <!-- These are free, publicly available Gemini models -->
                    <option value="gemini-1.5-flash-preview-05-20">gemini-1.5-flash-preview-05-20</option>
                    <option value="gemini-1.5-pro-preview-05-20">gemini-1.5-pro-preview-05-20</option>
                    <option value="gemini-1.0-pro">gemini-1.0-pro</option>
                    <option value="gemini-1.0-pro-vision-preview">gemini-1.0-pro-vision-preview</option>
                </select>
            </div>
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                <span class="block sm:inline"></span>
            </div>
            <button id="start-chat-button" class="w-full px-4 py-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors shadow-lg font-semibold">
                Start Chat
            </button>
        </div>

        <!-- Chat Interface (Hidden by Default) -->
        <div id="chat-interface" class="hidden flex-col h-full overflow-hidden">
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 rounded-lg bg-gray-50 border border-gray-200 mb-4 shadow-inner">
                <!-- Chat messages will be appended here dynamically -->
            </div>
            <form id="chat-form" class="flex space-x-2">
                <input
                    id="user-input"
                    type="text"
                    placeholder="Type your message..."
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                >
                <button
                    id="send-button"
                    type="submit"
                    class="px-6 py-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors shadow-lg font-semibold"
                >
                    Send
                </button>
            </form>
        </div>
    </div>

    <script>
        // Store the chat history as a global array.
        let chatHistory = [];
        let isLoading = false;

        // Get references to all the necessary HTML elements.
        const appContainer = document.getElementById('app-container');
        const setupSection = document.getElementById('setup-section');
        const chatInterface = document.getElementById('chat-interface');
        const apiKeyInput = document.getElementById('api-key-input');
        const modelSelect = document.getElementById('model-select');
        const startChatButton = document.getElementById('start-chat-button');
        const resetButton = document.getElementById('reset-button');
        const errorMessageDiv = document.getElementById('error-message');
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        // Event listener for the "Start Chat" button.
        startChatButton.addEventListener('click', () => {
            const apiKey = apiKeyInput.value.trim();
            if (apiKey === '') {
                displayError('Please enter a valid API key to begin.');
                return;
            }
            // Hide setup and show chat interface.
            setupSection.classList.add('hidden');
            chatInterface.classList.remove('hidden');
            resetButton.classList.remove('hidden');
            displayMessage('system', `Hello! You are now chatting with ${modelSelect.value}. Ask me anything!`);
        });

        // Event listener for the "Reset" button.
        resetButton.addEventListener('click', () => {
            apiKeyInput.value = '';
            chatHistory = [];
            chatMessages.innerHTML = '';
            setupSection.classList.remove('hidden');
            chatInterface.classList.add('hidden');
            resetButton.classList.add('hidden');
            hideError();
        });

        // Event listener for the chat form submission.
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userMessage = userInput.value.trim();
            if (userMessage === '') return;

            displayMessage('user', userMessage);
            userInput.value = '';
            sendMessage(userMessage);
        });

        // A helper function to display messages in the chat window.
        function displayMessage(sender, text, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `max-w-xs md:max-w-md lg:max-w-lg px-4 py-2 rounded-xl shadow-md text-sm ${
                sender === 'user'
                    ? 'bg-blue-500 text-white rounded-br-none'
                    : 'bg-gray-200 text-gray-800 rounded-bl-none'
            } ${isError ? 'bg-red-500 text-white' : ''}`;
            
            // Set the message text.
            bubbleDiv.textContent = text;
            messageDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to the bottom of the chat window.
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Displays an error message in the setup section.
        function displayError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Hides the error message.
        function hideError() {
            errorMessageDiv.classList.add('hidden');
            errorMessageDiv.textContent = '';
        }

        // A function to display a loading indicator.
        function showLoading() {
            isLoading = true;
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div class="px-4 py-2 rounded-xl bg-gray-200 text-gray-800 text-sm shadow-md">
                    <div class="dot-pulse"></div>
                </div>
            `;
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            sendButton.disabled = true;
            userInput.disabled = true;
        }

        // A function to hide the loading indicator.
        function hideLoading() {
            isLoading = false;
            const loadingDiv = document.getElementById('loading-indicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
            sendButton.disabled = false;
            userInput.disabled = false;
        }

        // Main function to send the message to the Gemini API.
        async function sendMessage(userMessage) {
            showLoading();
            
            // Add the user message to the chat history array.
            chatHistory.push({ role: 'user', parts: [{ text: userMessage }] });

            const payload = {
                contents: chatHistory
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelSelect.value}:generateContent?key=${apiKeyInput.value.trim()}`;

            try {
                let response;
                let retries = 0;
                const maxRetries = 5;
                const initialDelay = 1000; // 1 second

                while (retries < maxRetries) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    });

                    if (response.ok) {
                        break; // Exit the loop if the request was successful
                    } else if (response.status === 429 && retries < maxRetries - 1) {
                        // Handle rate limiting with exponential backoff.
                        const delay = initialDelay * Math.pow(2, retries);
                        await new Promise(res => setTimeout(res, delay));
                        retries++;
                    } else {
                        // If the status is not 429 or max retries are reached, throw an error.
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorData.error.message}`);
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error('Failed to get a response from the API after multiple retries.');
                }
                
                const result = await response.json();
                const aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (aiResponseText) {
                    displayMessage('model', aiResponseText);
                    // Add the model's response to the chat history for context in future turns.
                    chatHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
                } else {
                    displayMessage('system', 'Sorry, I couldn\'t generate a response. Please try again.', true);
                }
            } catch (err) {
                console.error(err);
                displayMessage('system', `An error occurred: ${err.message}`, true);
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html>
